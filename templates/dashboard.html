<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ title }}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <link href="{{ url_for('static', filename='css/style.css') }}" rel="stylesheet">
  <script src="{{ url_for('static', filename='js/chart.umd.js') }}"></script>
</head>
<body>
  <!-- Navigasi Atas -->
  <nav class="navbar navbar-expand-lg shadow-sm sticky-top">
    <div class="container">
      <a class="navbar-brand fw-bold text-success d-flex align-items-center" href="{{ url_for('dashboard') }}">
        <i class="bi bi-graph-up-arrow me-2"></i> Koperasi Dashboard
      </a>
      <div class="ms-auto">
        <a class="btn btn-header-outline rounded-3" href="{{ url_for('index') }}">
          <i class="bi bi-table me-1"></i> Tabel Data
        </a>
      </div>
    </div>
  </nav>

  <!-- Header Ringkasan -->
  <div class="py-3 text-center header-highlight">
    <div class="container">
      <div class="d-inline-flex align-items-center bg-white px-4 py-2 rounded-pill shadow-sm">
        <i class="bi bi-bar-chart-line-fill text-success me-2" style="font-size:1.2rem;"></i>
        <h5 class="fw-bold mb-0 text-success">Dashboard Ringkasan</h5>
      </div>
    </div>
  </div>

  <!-- Fallback jika data tidak ada -->
  {% set _total_pokok = total_pinjaman_pokok|default(0) %}
  {% set _total_tagihan = total_tagihan|default(0) %}
  {% set _sisa = sisa_pinjaman|default(0) %}
  {% set _total_dibayar = (_total_tagihan - _sisa)|default(0) %}

  <!-- Konten Utama -->
  <div class="container py-4">
    <!-- KPI (Key Performance Indicators) -->
    <div class="row g-3 mb-3">
      <!-- Total Peminjam -->
      <div class="col-6 col-md-4 col-lg">
        <div class="card kpi-card h-100">
          <div class="card-body d-flex align-items-center">
            <i class="bi bi-people-fill text-success kpi-icon"></i>
            <div class="text-start">
              <small class="text-muted d-block">Total Peminjam</small>
              <h3 class="fw-bold mb-0">{{ total_karyawan|default(0) }}</h3>
            </div>
          </div>
        </div>
      </div>
      <!-- Total Pinjaman Pokok -->
      <div class="col-6 col-md-4 col-lg">
        <div class="card kpi-card h-100">
          <div class="card-body d-flex align-items-center">
            <i class="bi bi-journal-text text-info kpi-icon"></i>
            <div class="text-start">
              <small class="text-muted d-block">Total Pinjaman Pokok</small>
              <div class="kpi-money text-info fw-bold">
                <small>Rp</small><h3 class="mb-0">{{ "{:,.0f}".format(_total_pokok) }}</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Total (+Bunga) -->
      <div class="col-6 col-md-4 col-lg">
        <div class="card kpi-card h-100">
          <div class="card-body d-flex align-items-center">
            <i class="bi bi-cash-coin text-primary kpi-icon"></i>
            <div class="text-start">
              <small class="text-muted d-block">Total (+Bunga)</small>
              <div class="kpi-money text-primary fw-bold">
                <small>Rp</small><h3 class="mb-0">{{ "{:,.0f}".format(_total_tagihan) }}</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Sudah Dibayar -->
      <div class="col-6 col-md-6 col-lg">
        <div class="card kpi-card h-100">
          <div class="card-body d-flex align-items-center">
            <i class="bi bi-graph-up-arrow text-success kpi-icon"></i>
            <div class="text-start">
              <small class="text-muted d-block">Sudah Dibayar</small>
              <div class="kpi-money text-success fw-bold">
                <small>Rp</small><h3 class="mb-0">{{ "{:,.0f}".format(_total_dibayar if _total_dibayar > 0 else 0) }}</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
      <!-- Sisa Pinjaman -->
      <div class="col-12 col-md-6 col-lg">
        <div class="card kpi-card h-100">
          <div class="card-body d-flex align-items-center">
            <i class="bi bi-exclamation-triangle-fill text-danger kpi-icon"></i>
            <div class="text-start">
              <small class="text-muted d-block">Sisa Pinjaman</small>
              <div class="kpi-money text-danger fw-bold">
                <small>Rp</small><h3 class="mb-0">{{ "{:,.0f}".format(_sisa) }}</h3>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>


    <!-- Chart Status & Divisi -->
    <div class="row g-3">
      <!-- Chart Status Pinjaman -->
      <div class="col-lg-5">
        <div class="card soft-card h-100">
          <div class="card-header text-center pt-3">
            <h5 class="fw-bold mb-0">Status Pinjaman</h5>
          </div>
          <div class="card-body chart-status">
            <canvas id="statusChart"></canvas>
          </div>
          <div class="px-3 pb-3">
            <table class="table table-sm mini-table mb-0">
              <thead>
                <tr>
                  <th>Status</th>
                  <th>Jumlah</th>
                  <th>Sisa (Rp)</th>
                </tr>
              </thead>
              <tbody>
                {% set n = status_details.labels|length %}
                {% for i in range(n) %}
                <tr>
                  <td>{{ status_details.labels[i] }}</td>
                  <td>{{ status_details.counts[i] }}</td>
                  <td>{{ "Rp {:,.0f}".format(status_details.amounts[i]) }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Chart Pinjaman per Divisi -->
      <div class="col-lg-7">
        <div class="card soft-card h-100">
          <div class="card-header text-center pt-3">
            <h5 class="fw-bold mb-0">Pinjaman per Divisi</h5>
          </div>
          <div class="card-body chart-divisi">
            <canvas id="divisiChart"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Chart Top 10 Peminjam -->
    <div class="row g-3 mt-3">
      <div class="col-12">
        <div class="card soft-card h-100">
          <div class="card-header text-center pt-3">
            <h5 class="fw-bold mb-0">Top 10 Peminjam Terbesar</h5>
          </div>
          <div class="card-body chart-top10">
            <canvas id="topBorrowersChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="{{ url_for('static', filename='js/bootstrap.bundle.min.js') }}"></script>
  <script>
    // Helper function untuk format angka ke Rupiah
    const rupiah = v => new Intl.NumberFormat('id-ID',{style:'currency',currency:'IDR',minimumFractionDigits:0,maximumFractionDigits:0}).format(v);

    // --- Chart 1: Status Pinjaman (Doughnut) ---
    const statusDetails = JSON.parse(`{{ status_details|tojson|safe }}`);
    new Chart(document.getElementById('statusChart'),{
      type:'doughnut',
      data:{ 
        labels: statusDetails.labels, 
        datasets:[{ 
          data: statusDetails.counts, 
          backgroundColor:['#16a34a','#2563eb','#f59e0b'], 
          borderColor:'#fff', 
          borderWidth:2, 
          hoverOffset:6 
        }] 
      },
      options:{ 
        responsive:true, 
        maintainAspectRatio:false, 
        plugins:{ 
          legend:{ position:'bottom' }, 
          tooltip:{ callbacks:{ 
            label(ctx){ const i=ctx.dataIndex; const count=statusDetails.counts[i]??0; const pct=statusDetails.percentages[i]??0; return `${ctx.label}: ${count} org (${pct}%)`; }, 
            afterLabel(ctx){ const i=ctx.dataIndex; if(ctx.label==='Lunas') return null; return `Sisa: ${rupiah(statusDetails.amounts[i] ?? 0)}`; } 
          }} 
        } 
      }
    });

    // --- Chart 2: Pinjaman per Divisi (Bar) ---
    const divisiLabels = JSON.parse(`{{ bagian_pinjaman.keys()|list|tojson|safe }}`);
    const divisiTotal  = JSON.parse(`{{ bagian_pinjaman.values()|list|tojson|safe }}`);
    const divisiSisa   = JSON.parse(`{{ bagian_sisa.values()|list|tojson|safe }}`);
    new Chart(document.getElementById('divisiChart'), {
      type: 'bar',
      data: { 
        labels: divisiLabels, 
        datasets: [
          { label: 'Sisa Pinjaman', data: divisiSisa, backgroundColor: '#ef4444', borderRadius: { topLeft: 10, topRight: 10 }, borderSkipped: 'bottom' },
          { label: 'Total (+Bunga)', data: divisiTotal, backgroundColor: '#2563eb', borderRadius: { topLeft: 10, topRight: 10 }, borderSkipped: 'bottom' }
        ]
      },
      options: { 
        responsive:true, 
        maintainAspectRatio:false, 
        categoryPercentage:.7, 
        barPercentage:.85,
        plugins:{ 
          legend:{ position:'top' }, 
          tooltip:{ callbacks:{ label:(ctx)=>`${ctx.dataset.label}: Rp ${(ctx.parsed.y/1_000_000).toFixed(1)} Jt` } } 
        },
        scales:{ 
          x:{ ticks:{ maxRotation:28, minRotation:28 } }, 
          y:{ ticks:{ callback:v=>'Rp '+(v/1_000_000).toFixed(0)+' Jt' } } 
        }
      }
    });

    // --- Chart 3: Top 10 Peminjam Terbesar (Horizontal Bar) ---
    const tbRaw = JSON.parse(`{{ top_borrowers|tojson|safe }}`) || [];
    const tbLabels = tbRaw.map(x => x.nama);
    const tbTotal  = tbRaw.map(x => Number(x.jumlah || 0));
    const tbSisa   = tbRaw.map(x => Number(x.sisa || 0));
    const tbBayar  = tbRaw.map(x => Number(x.dibayar || 0));
    new Chart(document.getElementById('topBorrowersChart'),{
      type:'bar',
      data:{ 
        labels:tbLabels, 
        datasets:[
          { label:'Total (+Bunga)', data:tbTotal, backgroundColor:'#2563eb', borderRadius:{ topRight:10, bottomRight:10 }, borderSkipped:'left' },
          { label:'Dibayar', data:tbBayar, backgroundColor:'#16a34a', borderRadius:{ topRight:10, bottomRight:10 }, borderSkipped:'left' },
          { label:'Sisa', data:tbSisa, backgroundColor:'#dc2626', borderRadius:{ topRight:10, bottomRight:10 }, borderSkipped:'left' }
        ]
      },
      options:{ 
        indexAxis:'y', 
        responsive:true, 
        maintainAspectRatio:false, 
        categoryPercentage:.7, 
        barPercentage:.85,
        plugins:{ legend:{ position:'top' } },
        scales:{ 
          x:{ ticks:{ callback:v=>'Rp '+(v/1_000_000).toFixed(0)+' Jt' } }, 
          y:{ ticks:{ autoSkip:false } } 
        }
      }
    });
  </script>
</body>
</html>

